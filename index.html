<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FL Studio Wallpaper App</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // Global namespace for the application
    window.WallpaperApp = {
      config: {
        version: '0.2.2-fixed',
        animationDuration: 300,
        tooltipDelay: 500,
        notificationDuration: 3000
      },

      // Module registration system
      modules: {},
      registerModule(name, module) {
        console.log('Registering module:', name);
        this.modules[name] = module;
      },
      getModule(name) {
        return this.modules[name];
      },

      // UI Management Module
      UI: {
        showNotification(message, type = 'info') {
          const container = document.getElementById('notification-container');
          if (!container) return;
          container.style.visibility = 'visible';
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.innerHTML = `<div class="notification-content">${message}</div><button class="btn btn-icon notification-close">&times;</button>`;
          container.appendChild(notification);
          const close = () => {
            notification.classList.remove('show');
            setTimeout(() => {
              notification.remove();
              if (container.children.length === 0) container.style.visibility = 'hidden';
            }, 300);
          };
          notification.querySelector('.notification-close').addEventListener('click', close);
          requestAnimationFrame(() => notification.classList.add('show'));
          setTimeout(close, WallpaperApp.config.notificationDuration);
        },
        showModal(options) {
          const { id, title, content, footerButtons } = options;
          const modalContainer = document.getElementById('modal-container');
          if (!modalContainer) return;
          const modal = document.createElement('div');
          modal.className = 'modal acrylic acrylic-dark';
          modal.id = id || `modal-${Date.now()}`;
          modal.innerHTML = `
            <div class="modal-header">
              <h2 class="modal-title">${title || 'Modal Title'}</h2>
              <button class="btn btn-icon modal-close">&times;</button>
            </div>
            <div class="modal-body">${typeof content === 'string' ? `<p>${content}</p>` : ''}</div>
            <div class="modal-footer"></div>`;
          if (content instanceof HTMLElement) modal.querySelector('.modal-body').appendChild(content);
          const modalFooter = modal.querySelector('.modal-footer');
          if (footerButtons?.length > 0) {
            footerButtons.forEach(btnData => {
              const button = document.createElement('button');
              button.textContent = btnData.text;
              button.className = `btn ${btnData.classes || 'btn-secondary'}`;
              button.addEventListener('click', () => { if (btnData.onClick() !== false) this.hideModal(modal.id); });
              modalFooter.appendChild(button);
            });
          } else {
            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'btn btn-primary';
            okButton.addEventListener('click', () => this.hideModal(modal.id));
            modalFooter.appendChild(okButton);
          }
          modalContainer.appendChild(modal);
          modalContainer.style.display = 'flex';
          modal.querySelector('.modal-close').addEventListener('click', () => this.hideModal(modal.id));
          requestAnimationFrame(() => modal.classList.add('show'));
        },
        hideModal(id) {
          const modalContainer = document.getElementById('modal-container');
          const modalToHide = id ? document.getElementById(id) : modalContainer?.querySelector('.modal');
          if (modalToHide) {
            modalToHide.classList.remove('show');
            setTimeout(() => {
              modalToHide.remove();
              if (modalContainer?.children.length === 0) modalContainer.style.display = 'none';
            }, WallpaperApp.config.animationDuration);
          }
        }
      },
      // Menu Tools Module
      MenuTools: {
        state: { openL2Submenu: null, activePerClipTransitionsPanel: null, currentTargetId: null, currentTargetType: null },
        setL2Target(id, type) { this.state.currentTargetId = id; this.state.currentTargetType = type; },
        setupL2ItemListeners(parentId) {
          const parent = document.getElementById(parentId);
          parent?.querySelectorAll('.submenu-item-l2').forEach(item => {
            if (item._l2ClickHandler) item.removeEventListener('click', item._l2ClickHandler);
            const handler = () => this.handleL2ItemClick(item);
            item.addEventListener('click', handler);
            item._l2ClickHandler = handler;
          });
        },
        handleL2ItemClick(item) {
          const parentMenu = item.closest('.slide-submenu-l2');
          if (!parentMenu) return;
          const itemId = item.getAttribute('data-effect-id');
          const itemType = 'effect';
          let controls = item.nextElementSibling;
          if (!controls || !controls.classList.contains('parameter-controls-container')) {
            controls = document.createElement('div');
            controls.className = 'parameter-controls-container';
            item.parentNode.insertBefore(controls, item.nextSibling);
          }
          const MediaManager = WallpaperApp.getModule('MediaManager');
          if (MediaManager?.getParamsFor) {
            MediaManager.getParamsFor(itemId, itemType, controls, this.state.currentTargetId, this.state.currentTargetType);
          }
          this.toggleL2ItemExpansion(item, controls, parentMenu);
        },
        toggleL2ItemExpansion(item, controls, parentMenu) {
          const isVisible = controls.classList.contains('visible');
          parentMenu.querySelectorAll('.parameter-controls-container.visible').forEach(c => {
            if (c !== controls) { c.classList.remove('visible'); c.style.maxHeight = '0px'; c.previousElementSibling?.classList.remove('expanded'); }
          });
          item.classList.toggle('expanded', !isVisible);
          controls.classList.toggle('visible', !isVisible);
          controls.style.maxHeight = !isVisible ? controls.scrollHeight + "px" : '0px';
        },
        openPerClipTransitionsPanel(index, clipName) {
          const panel = document.getElementById('per-clip-transitions-panel');
          const wrapper = document.getElementById('slide-left-panel-wrapper');
          const importSubmenu = document.getElementById('import-media-submenu');
          if (!panel || !wrapper || !importSubmenu) return;
          if (this.state.activePerClipTransitionsPanel) this.closePerClipTransitionsPanel();
          panel.querySelector('.panel-header-title').textContent = `Transitions for: ${clipName}`;
          const MediaManager = WallpaperApp.getModule('MediaManager');
          if (MediaManager?.populatePerClipTransitions) MediaManager.populatePerClipTransitions(index);
          wrapper.style.right = `calc(var(--menu-width) + ${importSubmenu.offsetWidth}px)`;
          wrapper.style.display = 'block';
          requestAnimationFrame(() => wrapper.classList.add('active'));
          this.state.activePerClipTransitionsPanel = panel;
          document.getElementById('main-menu').classList.add('main-menu-slide-left-active');
        },
        closePerClipTransitionsPanel() {
          const wrapper = document.getElementById('slide-left-panel-wrapper');
          if (!this.state.activePerClipTransitionsPanel || !wrapper) return;
          this.state.activePerClipTransitionsPanel = null;
          document.getElementById('main-menu').classList.remove('main-menu-slide-left-active');
          wrapper.classList.remove('active');
          setTimeout(() => { if (!wrapper.classList.contains('active')) wrapper.style.display = 'none'; }, 350);
        }
      },
    };
  </script>
</head>
<body style="overflow: hidden;">
<div id="app-container">
  <div id="background-container" class="module-container"></div>
  <div id="media-container" class="module-container"></div>
  <div id="visualizer-container" class="module-container"></div>

  <div class="menu-hover-area">
    <div id="menu-trigger" class="menu-trigger right">
      <div class="trigger-indicator"></div>
    </div>
  </div>

  <nav id="main-menu" class="slide-menu right acrylic acrylic-dark">
    <div class="menu-header">
      <h1>CLUTCHBOYZ üåê</h1>
      <button class="btn btn-icon menu-close" aria-label="Close menu">&times;</button>
    </div>
    <div class="menu-content">
      <div class="menu-section" data-section="main">
        <h2 style="text-align: center; width: 100%;">MENU</h2>
        <hr class="divider">
        <button class="category-item" data-action="import-media" data-tooltip="Import and manage your media files, create playlists">MEDIA PLAYER</button>
        <button class="category-item" data-action="effects" data-tooltip="Apply visual effects to your media">EFFECTS</button>
        <hr class="divider">
        <button class="category-item" data-action="daw-integration" data-tooltip="Connect with your Digital Audio Workstation">DAW INTEGRATION</button>
        <button class="category-item" data-action="performance" data-tooltip="Optimize performance for your system">PERFORMANCE</button>
        <button class="category-item" data-action="extra" data-tooltip="Additional features and customizations">EXTRA</button>
        <hr class="divider">
        <button class="category-item" data-action="config-settings" data-tooltip="Configure application settings">CONFIG SETTINGS</button>
        <button class="category-item" data-action="menu-settings" data-tooltip="Customize menu appearance and behavior">MENU SETTINGS</button>
        <button class="category-item" data-action="about" data-tooltip="About this application and credits">ABOUT</button>
        <hr class="divider">
      </div>
    </div>
    <div class="menu-footer">
      <div class="version-info">v0.2.2</div>
    </div>
  </nav>

  <div class="submenu-wrapper">
    <div id="import-media-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>MEDIA PLAYER</h1>
        <button class="btn btn-icon submenu-close">&times;</button>
      </div>
      <div class="menu-content"><!-- Filled by media-manager.js --></div>
      <div class="menu-footer"></div>
    </div>

    <div id="daw-integration-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>DAW INTEGRATION</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section">
        <button class="submenu-item" data-action="fl-studio-connection" data-tooltip="Connect to FL Studio for theme synchronization">FL STUDIO</button>
      </div></div>
    </div>

    <div id="performance-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>PERFORMANCE</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section"><p>Settings soon...</p></div></div>
    </div>

    <div id="extra-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>EXTRA</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section"><p>Settings soon...</p></div></div>
    </div>

    <div id="config-settings-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>CONFIG SETTINGS</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section"><p>Settings soon...</p></div></div>
    </div>

    <div id="menu-settings-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>MENU SETTINGS</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section"><p>Settings soon...</p></div></div>
    </div>

    <div id="about-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header"><h1>ABOUT</h1><button class="btn btn-icon submenu-close">&times;</button></div>
      <div class="menu-content"><div class="menu-section"><p>App by vsurp</p></div></div>
    </div>
  </div>

  <div class="submenu-wrapper-l2">
    <div id="effects-list-submenu" class="slide-submenu-l2 acrylic acrylic-dark">
      <div class="menu-header">
        <h1>EFFECTS LIST</h1>
        <button class="btn btn-icon submenu-close-l2">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section"><!-- Filled by script --></div>
      </div>
    </div>
  </div>

  <div id="slide-left-panel-wrapper" class="slide-left-panel-wrapper" style="display: none;">
    <div id="per-clip-transitions-panel" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1 class="panel-header-title">TRANSITIONS FOR CLIP</h1>
        <button class="btn btn-icon panel-close">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section" id="per-clip-transitions-list"></div>
      </div>
    </div>
  </div>

  <div id="notification-container" style="visibility: hidden;"></div>
  <div id="modal-container" style="display: none;"></div>
  <div id="context-menu-container" class="context-menu"></div>
  <div id="inline-panel-container" class="inline-panel"></div>
</div>

<!-- ** FIX: Load scripts with defer to ensure execution order ** -->
<script src="player-engine.js" defer></script>
<script src="media-manager.js" defer></script>

<script>
  // This script will also be deferred by the browser, running after the two above.
  document.addEventListener('DOMContentLoaded', function() {
    try {
      console.log("DOM fully loaded. Initializing application...");

      // With 'defer', PlayerEngine and MediaManager are guaranteed to be defined.
      if (typeof PlayerEngine === 'undefined' || typeof MediaManager === 'undefined') {
        throw new Error("A core module (PlayerEngine or MediaManager) failed to load.");
      }

      // 1. Register modules so they can be accessed globally via WallpaperApp.getModule
      WallpaperApp.registerModule('PlayerEngine', PlayerEngine);
      WallpaperApp.registerModule('MediaManager', MediaManager);

      // 2. Initialize the main manager module. It will handle initializing the player engine.
      MediaManager.init();

      // 3. Initialize UI components
      const menuSystem = setupMenuSystem();
      if (!menuSystem.success) {
        throw new Error('Menu system initialization failed');
      }

      const MediaManagerModule = WallpaperApp.getModule('MediaManager');
      if (MediaManagerModule && typeof MediaManagerModule.getAvailableEffects === 'function') {
        populateL2Submenu('effects-list-submenu', MediaManagerModule.getAvailableEffects(), 'effect');
        WallpaperApp.MenuTools.setupL2ItemListeners('effects-list-submenu');
      }

      const perClipPanelCloseBtn = document.querySelector('#per-clip-transitions-panel .panel-close');
      if (perClipPanelCloseBtn) {
        perClipPanelCloseBtn.addEventListener('click', () => {
          WallpaperApp.MenuTools.closePerClipTransitionsPanel();
        });
      }
      console.log("Application initialization complete.");
    } catch (error) {
      console.error('[App Initialization] Critical error:', error);
      WallpaperApp.UI.showNotification('Failed to initialize application. Check console.', 'error');
    }

    function populateL2Submenu(submenuId, items, type) {
      const submenu = document.getElementById(submenuId);
      const menuContentSection = submenu?.querySelector('.menu-content .menu-section');
      if (!menuContentSection) return;
      menuContentSection.innerHTML = '';
      items.forEach(item => {
        const button = document.createElement('button');
        button.className = 'submenu-item-l2';
        button.textContent = item.name;
        button.setAttribute('data-tooltip', `Apply ${item.name} effect`);
        if (type === 'effect') button.setAttribute('data-effect-id', item.id);
        menuContentSection.appendChild(button);
      });
    }

    function setupMenuSystem() {
      try {
        const menuTrigger = document.getElementById('menu-trigger');
        const mainMenu = document.getElementById('main-menu');
        const menuClose = mainMenu?.querySelector('.menu-close');
        const categoryItems = document.querySelectorAll('#main-menu .category-item');
        const submenuWrapperL1 = document.querySelector('.submenu-wrapper');
        const submenuWrapperL2 = document.querySelector('.submenu-wrapper-l2');

        if (!mainMenu || !submenuWrapperL1 || !submenuWrapperL2) {
          console.error("Critical menu elements not found.");
          return { success: false };
        }

        const menuState = { animationInProgress: false };
        const afterAnimation = (callback) => setTimeout(callback, WallpaperApp.config.animationDuration + 50);

        async function closeLevel2Submenus(keepL1Open = false) {
          const activeL2Wrapper = document.querySelector('.submenu-wrapper-l2.active');
          if (activeL2Wrapper) {
            activeL2Wrapper.classList.remove('active');
            if (!keepL1Open) mainMenu.classList.remove('main-menu-l2-active');
            return new Promise(resolve => afterAnimation(() => {
              if (!activeL2Wrapper.classList.contains('active')) activeL2Wrapper.style.display = 'none';
              resolve();
            }));
          }
          return Promise.resolve();
        }

        async function closeLevel1Submenus(keepMainMenuOpen = false) {
          await closeLevel2Submenus(true);
          await WallpaperApp.MenuTools.closePerClipTransitionsPanel();
          const activeL1Wrapper = document.querySelector('.submenu-wrapper.active');
          if (activeL1Wrapper) {
            activeL1Wrapper.querySelectorAll('.slide-submenu.active').forEach(s => s.classList.remove('active'));
            activeL1Wrapper.classList.remove('active');
            if (!keepMainMenuOpen) mainMenu.classList.remove('main-menu-submenu-active', 'main-menu-l2-active', 'main-menu-slide-left-active');
            return new Promise(resolve => afterAnimation(() => {
              if (!activeL1Wrapper.classList.contains('active')) activeL1Wrapper.style.display = 'none';
              resolve();
            }));
          }
          return Promise.resolve();
        }

        async function closeMainMenu() {
          if (menuState.animationInProgress) return;
          menuState.animationInProgress = true;
          await closeLevel1Submenus();
          mainMenu.classList.remove('active');
          afterAnimation(() => menuState.animationInProgress = false);
        }

        menuTrigger?.addEventListener('click', () => !mainMenu.classList.contains('active') ? mainMenu.classList.add('active') : closeMainMenu());
        menuClose?.addEventListener('click', closeMainMenu);

        categoryItems.forEach(item => {
          item.addEventListener('click', async () => {
            const action = item.getAttribute('data-action');
            const isEffects = action === 'effects';
            const targetSubmenuId = isEffects ? 'effects-list-submenu' : action + '-submenu';
            const targetSubmenu = document.getElementById(targetSubmenuId);

            if (item.classList.contains('selected')) {
              item.classList.remove('selected');
              isEffects ? await closeLevel2Submenus() : await closeLevel1Submenus();
            } else {
              categoryItems.forEach(i => i.classList.remove('selected'));
              item.classList.add('selected');

              if (isEffects) {
                await closeLevel1Submenus(true);
                submenuWrapperL2.style.display = 'block';
                requestAnimationFrame(() => {
                  mainMenu.classList.add('main-menu-l2-active');
                  submenuWrapperL2.classList.add('active');
                  targetSubmenu.classList.add('active');
                });
              } else if (targetSubmenu) {
                await closeLevel1Submenus(true);
                submenuWrapperL1.style.display = 'block';
                const activeSub = submenuWrapperL1.querySelector('.slide-submenu.active');
                if(activeSub) activeSub.classList.remove('active');

                requestAnimationFrame(() => {
                  mainMenu.classList.add('main-menu-submenu-active');
                  submenuWrapperL1.classList.add('active');
                  targetSubmenu.classList.add('active');
                });
              } else {
                await closeLevel1Submenus(true);
              }
            }
          });
        });

        document.querySelectorAll('.submenu-wrapper .submenu-close, .submenu-wrapper-l2 .submenu-close-l2').forEach(btn => {
          btn.addEventListener('click', async () => {
            const parentSubmenu = btn.closest('.slide-submenu, .slide-submenu-l2');
            if (parentSubmenu) {
              const action = parentSubmenu.id.replace('-submenu', '').replace('-list', '');
              document.querySelector(`.category-item[data-action="${action}"]`)?.classList.remove('selected');
            }
            if (btn.classList.contains('submenu-close-l2')) await closeLevel2Submenus();
            else await closeLevel1Submenus();
          });
        });

        document.addEventListener('keydown', async (e) => {
          if (e.key === 'Escape') {
            if (document.querySelector('.modal.show')) WallpaperApp.UI.hideModal();
            else if (WallpaperApp.MenuTools.state.activePerClipTransitionsPanel) await WallpaperApp.MenuTools.closePerClipTransitionsPanel();
            else if (document.querySelector('.submenu-wrapper-l2.active')) await closeLevel2Submenus();
            else if (document.querySelector('.submenu-wrapper.active')) await closeLevel1Submenus();
            else if (mainMenu.classList.contains('active')) await closeMainMenu();
          }
        });

        return { success: true };
      } catch(e) {
        console.error("MenuSystem init failed:", e);
        return { success: false };
      }
    }
  });
</script>

</body>
</html>
