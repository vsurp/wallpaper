<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FL Studio Wallpaper App</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // Global namespace for the application
    window.WallpaperApp = {
      config: {
        version: '0.1.3',
        animationDuration: 300,
        tooltipDelay: 1000,
        notificationDuration: 3000
      },

      registerModule(name, module) {
        console.log('Registered module:', name);
        this[name] = module;
      },

      UI: {
        showNotification(message, type = 'info') {
          const container = document.getElementById('notification-container');
          if (!container) {
            console.log(`Notification (${type}): ${message}`);
            return;
          }

          // Ensure container is visible
          if (container.children.length === 0) {
            container.style.visibility = 'visible';
          }

          // Create notification
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.innerHTML = `
            <div class="notification-content">${message}</div>
            <button class="btn btn-icon notification-close" aria-label="Close notification">&times;</button>
          `;
          container.appendChild(notification);

          // Setup close functionality
          const closeBtn = notification.querySelector('.notification-close');
          const closeNotification = () => {
            notification.classList.remove('show');
            setTimeout(() => {
              if (notification.parentElement) {
                notification.remove();
                if (container.children.length === 0) {
                  container.style.visibility = 'hidden';
                }
              }
            }, 300);
          };

          closeBtn.addEventListener('click', closeNotification);

          // Show notification
          requestAnimationFrame(() => notification.classList.add('show'));

          // Auto-hide
          setTimeout(closeNotification, 3000);
        },

        showTooltip(element, content, position = 'bottom') {
          // TODO: Implement tooltip functionality
        },

        hideTooltip(tooltip) {
          // TODO: Implement tooltip functionality
        },

        showModal(options) {
          const { id, title, content, footerButtons } = options;
          const modalContainer = document.getElementById('modal-container');
          if (!modalContainer) return;

          // Create modal
          const modal = document.createElement('div');
          modal.className = 'modal acrylic acrylic-dark';
          modal.id = id || `modal-${Date.now()}`;
          modal.innerHTML = `
            <div class="modal-header">
              <h2 class="modal-title">${title || 'Modal Title'}</h2>
              <button class="btn btn-icon modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
              ${typeof content === 'string' ? `<p>${content}</p>` : ''}
            </div>
            <div class="modal-footer"></div>
          `;

          // Add custom content if element
          if (typeof content !== 'string' && content instanceof HTMLElement) {
            modal.querySelector('.modal-body').appendChild(content);
          }

          // Add footer buttons
          const modalFooter = modal.querySelector('.modal-footer');
          if (footerButtons && footerButtons.length > 0) {
            footerButtons.forEach(btnData => {
              const button = document.createElement('button');
              button.textContent = btnData.text;
              button.className = `btn ${btnData.classes || 'btn-secondary'}`;

              if (btnData.onClick) {
                button.addEventListener('click', () => {
                  if (btnData.onClick() !== false) {
                    WallpaperApp.UI.hideModal(modal.id);
                  }
                });
              } else {
                button.addEventListener('click', () => WallpaperApp.UI.hideModal(modal.id));
              }

              modalFooter.appendChild(button);
            });
          } else {
            // Default OK button
            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'btn btn-primary';
            okButton.addEventListener('click', () => WallpaperApp.UI.hideModal(modal.id));
            modalFooter.appendChild(okButton);
          }

          // Show modal
          modalContainer.appendChild(modal);
          modalContainer.style.display = 'flex';

          // Bind close button
          modal.querySelector('.modal-close').addEventListener('click', () => WallpaperApp.UI.hideModal(modal.id));

          // Animate in
          requestAnimationFrame(() => modal.classList.add('show'));
        },

        hideModal(id) {
          const modalContainer = document.getElementById('modal-container');
          const modalToHide = id ? document.getElementById(id) : modalContainer?.querySelector('.modal');

          if (modalToHide) {
            modalToHide.classList.remove('show');
            setTimeout(() => {
              if (modalToHide.parentElement) {
                modalToHide.parentElement.removeChild(modalToHide);
                if (modalContainer && modalContainer.children.length === 0) {
                  modalContainer.style.display = 'none';
                }
              }
            }, 300);
          }
        }
      },

      MenuTools: {
        openL2Submenu: null,
      },

      Utils: {
        // Add utility functions here
      }
    };
  </script>
</head>
<body style="overflow: hidden;">
<div id="app-container">
  <div id="background-container" class="module-container"></div>
  <div id="media-container" class="module-container"></div>
  <div id="visualizer-container" class="module-container"></div>

  <div class="menu-hover-area">
    <div id="menu-trigger" class="menu-trigger right">
      <div class="trigger-indicator"></div>
    </div>
  </div>

  <nav id="main-menu" class="slide-menu right acrylic acrylic-dark">
    <div class="menu-header">
      <h1>CLUTCHBOYZ üåê</h1>
      <button class="btn btn-icon menu-close" aria-label="Close menu">&times;</button>
    </div>

    <div class="menu-content">
      <div class="menu-section" data-section="main">
        <h2 style="text-align: center; width: 100%;">MENU</h2>
        <hr class="divider">

        <button class="category-item" data-action="import-media">MEDIA PLAYER</button>
        <button class="category-item" data-action="effects">EFFECTS</button>
        <button class="category-item" data-action="transitions">TRANSITIONS</button>
        <hr class="divider">

        <button class="category-item" data-action="daw-integration">DAW INTEGRATION</button>
        <button class="category-item" data-action="performance">PERFORMANCE</button>
        <button class="category-item" data-action="extra">EXTRA</button>
        <hr class="divider">

        <button class="category-item" data-action="config-settings">CONFIG SETTINGS</button>
        <button class="category-item" data-action="menu-settings">MENU SETTINGS</button>
        <button class="category-item" data-action="about">ABOUT</button>
        <hr class="divider">
      </div>
    </div>

    <div class="menu-footer">
      <div class="version-info">v0.1.3</div>
    </div>
  </nav>

  <div class="submenu-wrapper">
    <div id="import-media-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>MEDIA PLAYER</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content"></div>
      <div class="menu-footer"></div>
    </div>

    <div id="effects-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>EFFECTS (L1)</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content"><p>This L1 Effects menu is not directly used. Effects are accessed via Media Player.</p></div>
      <div class="menu-footer"></div>
    </div>

    <div id="transitions-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>TRANSITIONS (L1)</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content"><p>This L1 Transitions menu is not directly used. Transitions are accessed via Media Player.</p></div>
      <div class="menu-footer"></div>
    </div>

    <div id="daw-integration-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>DAW INTEGRATION</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="fl-studio-connection">FL STUDIO</button>
          <button class="submenu-item" data-action="ableton-connection">ABLETON LIVE</button>
          <button class="submenu-item" data-action="logic-connection">LOGIC PRO</button>
          <button class="submenu-item" data-action="pro-tools-connection">PRO TOOLS</button>
          <button class="submenu-item" data-action="custom-daw-connection">CUSTOM DAW</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="performance-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>PERFORMANCE</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="perf-opt1">OPTIMIZATION 1</button>
          <button class="submenu-item" data-action="perf-opt2">OPTIMIZATION 2</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="extra-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>EXTRA</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="visualizer-styles">VISUALIZER STYLES</button>
          <button class="submenu-item" data-action="clock-display">CLOCK DISPLAY</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="config-settings-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>CONFIG SETTINGS</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="startup-behavior">STARTUP BEHAVIOR</button>
          <button class="submenu-item" data-action="auto-save">AUTO SAVE</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="menu-settings-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>MENU SETTINGS</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="menu-position">MENU POSITION</button>
          <button class="submenu-item" data-action="menu-opacity">MENU OPACITY</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="about-submenu" class="slide-submenu acrylic acrylic-dark">
      <div class="menu-header">
        <h1>ABOUT</h1>
        <button class="btn btn-icon submenu-close" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item" data-action="app-info">APP INFORMATION</button>
          <button class="submenu-item" data-action="credits">CREDITS</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>
  </div>

  <div class="submenu-wrapper-l2">
    <div id="effects-list-submenu" class="slide-submenu-l2 acrylic acrylic-dark">
      <div class="menu-header">
        <h1>EFFECTS LIST</h1>
        <button class="btn btn-icon submenu-close-l2" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item-l2" data-effect-id="blur">BLUR</button>
          <button class="submenu-item-l2" data-effect-id="glow">GLOW</button>
          <button class="submenu-item-l2" data-effect-id="grayscale">GRAYSCALE</button>
          <button class="submenu-item-l2" data-effect-id="sepia">SEPIA</button>
          <button class="submenu-item-l2" data-effect-id="vignette">VIGNETTE</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>

    <div id="transitions-list-submenu" class="slide-submenu-l2 acrylic acrylic-dark">
      <div class="menu-header">
        <h1>TRANSITIONS LIST</h1>
        <button class="btn btn-icon submenu-close-l2" aria-label="Close submenu">&times;</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <button class="submenu-item-l2" data-transition-id="fade">FADE</button>
          <button class="submenu-item-l2" data-transition-id="slide">SLIDE</button>
          <button class="submenu-item-l2" data-transition-id="zoom">ZOOM</button>
          <button class="submenu-item-l2" data-transition-id="dissolve">DISSOLVE</button>
          <button class="submenu-item-l2" data-transition-id="custom">CUSTOM</button>
        </div>
      </div>
      <div class="menu-footer"></div>
    </div>
  </div>

  <div id="tooltip-container"></div>
  <div id="notification-container" style="visibility: hidden;"></div>
  <div id="modal-container" style="display: none;"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    WallpaperApp.UI.showNotification('FL Studio Wallpaper App ready!', 'success');
    setupMenuSystem();

    function setupMenuSystem() {
      const menuTrigger = document.getElementById('menu-trigger');
      const mainMenu = document.getElementById('main-menu');
      const menuClose = mainMenu.querySelector('.menu-close');
      const categoryItems = document.querySelectorAll('#main-menu .category-item');
      const submenuWrapperL1 = document.querySelector('.submenu-wrapper');
      const submenuWrapperL2 = document.querySelector('.submenu-wrapper-l2');
      const submenuCloseButtonsL1 = document.querySelectorAll('.submenu-wrapper .submenu-close');
      const submenuCloseButtonsL2 = document.querySelectorAll('.submenu-wrapper-l2 .submenu-close-l2');

      let menuAnimationTimeMs = 300;
      try {
        const cssValue = getComputedStyle(document.documentElement)
                .getPropertyValue('--menu-animation-time')
                .trim();
        if (cssValue.endsWith('ms')) {
          menuAnimationTimeMs = parseFloat(cssValue);
        } else if (cssValue.endsWith('s')) {
          menuAnimationTimeMs = parseFloat(cssValue) * 1000;
        }
      } catch (e) {
        console.warn("Could not parse --menu-animation-time.", e);
      }

      // Animation utilities
      function afterTransition(element, callback) {
        if (!element) {
          callback();
          return;
        }

        let fired = false;
        const handler = (event) => {
          if (fired) return;
          if (event.target === element &&
                  (event.propertyName === 'transform' || event.propertyName === 'width')) {
            fired = true;
            element.removeEventListener('transitionend', handler);
            callback();
          }
        };

        element.addEventListener('transitionend', handler);

        // Fallback timeout
        setTimeout(() => {
          if (!fired) {
            fired = true;
            element.removeEventListener('transitionend', handler);
            callback();
          }
        }, menuAnimationTimeMs + 50);
      }

      // Menu management functions
      async function closeLevel2Submenus() {
        return new Promise(resolve => {
          const activeL2Wrapper = document.querySelector('.submenu-wrapper-l2.active');
          if (activeL2Wrapper) {
            const activeL2Submenus = activeL2Wrapper.querySelectorAll('.slide-submenu-l2.active');
            activeL2Submenus.forEach(submenu => {
              submenu.classList.remove('active');
              // Close any open sliders in this submenu
              submenu.querySelectorAll('.intensity-slider-container.visible').forEach(container => {
                container.classList.remove('visible');
                container.style.maxHeight = '0px';
              });
              submenu.querySelectorAll('.submenu-item-l2.expanded').forEach(item => {
                item.classList.remove('expanded');
              });
            });

            activeL2Wrapper.classList.remove('active');
            mainMenu.classList.remove('main-menu-l2-active');

            afterTransition(activeL2Wrapper, () => {
              if (!activeL2Wrapper.classList.contains('active')) {
                activeL2Wrapper.style.display = 'none';
              }
              resolve();
            });
          } else {
            mainMenu.classList.remove('main-menu-l2-active');
            resolve();
          }
        });
      }

      async function closeLevel1Submenus() {
        return new Promise(async resolve => {
          await closeLevel2Submenus();

          const activeL1Wrapper = document.querySelector('.submenu-wrapper.active');
          if (activeL1Wrapper) {
            activeL1Wrapper.querySelectorAll('.slide-submenu.active').forEach(submenu => {
              submenu.classList.remove('active');
            });

            activeL1Wrapper.classList.remove('active');
            mainMenu.classList.remove('main-menu-submenu-active');

            afterTransition(activeL1Wrapper, () => {
              if (!activeL1Wrapper.classList.contains('active')) {
                activeL1Wrapper.style.display = 'none';
              }
              resolve();
            });
          } else {
            mainMenu.classList.remove('main-menu-submenu-active');
            resolve();
          }
        });
      }

      async function closeMainMenu() {
        return new Promise(async resolve => {
          await closeLevel1Submenus();

          if (mainMenu.classList.contains('active')) {
            mainMenu.classList.remove('active');
            afterTransition(mainMenu, resolve);
          } else {
            resolve();
          }
        });
      }

      async function openL1Submenu(targetL1Submenu) {
        return new Promise(resolve => {
          if (!targetL1Submenu) {
            resolve(false);
            return;
          }

          const currentActiveL1Submenu = submenuWrapperL1.querySelector('.slide-submenu.active');
          const targetCategoryItem = document.querySelector(
                  `.category-item[data-action="${targetL1Submenu.id.replace('-submenu', '')}"]`
          );

          if (currentActiveL1Submenu && currentActiveL1Submenu !== targetL1Submenu) {
            // Switch submenus
            currentActiveL1Submenu.classList.remove('active');
            mainMenu.classList.remove('main-menu-submenu-active');
            categoryItems.forEach(ci => ci.classList.remove('selected'));
            if (targetCategoryItem) targetCategoryItem.classList.add('selected');

            afterTransition(submenuWrapperL1, () => {
              targetL1Submenu.classList.add('active');
              submenuWrapperL1.style.display = 'block';
              requestAnimationFrame(() => {
                submenuWrapperL1.classList.add('active');
                mainMenu.classList.add('main-menu-submenu-active');
                afterTransition(submenuWrapperL1, () => resolve(true));
              });
            });
          } else if (!currentActiveL1Submenu) {
            // Open first submenu
            targetL1Submenu.classList.add('active');
            submenuWrapperL1.style.display = 'block';
            categoryItems.forEach(ci => ci.classList.remove('selected'));
            if (targetCategoryItem) targetCategoryItem.classList.add('selected');

            requestAnimationFrame(() => {
              submenuWrapperL1.classList.add('active');
              mainMenu.classList.add('main-menu-submenu-active');
              afterTransition(submenuWrapperL1, () => resolve(true));
            });
          } else if (currentActiveL1Submenu === targetL1Submenu) {
            // Already open or trying to re-open the same
            if (!submenuWrapperL1.classList.contains('active')) {
              submenuWrapperL1.style.display = 'block';
              requestAnimationFrame(() => {
                submenuWrapperL1.classList.add('active');
                mainMenu.classList.add('main-menu-submenu-active');
                afterTransition(submenuWrapperL1, () => resolve(true));
              });
            } else {
              mainMenu.classList.add('main-menu-submenu-active');
              resolve(true);
            }
          }
        });
      }

      // Event handlers
      menuTrigger.addEventListener('click', async () => {
        if (mainMenu.classList.contains('active')) {
          await closeMainMenu();
        } else {
          mainMenu.classList.add('active');
        }
      });

      if (menuClose) {
        menuClose.addEventListener('click', closeMainMenu);
      }

      categoryItems.forEach(item => {
        item.addEventListener('click', async () => {
          const action = item.getAttribute('data-action');
          const isEffectsAction = action === 'effects';
          const isTransitionsAction = action === 'transitions';

          const targetL1SubmenuId = `${action}-submenu`;
          const targetL1Submenu = document.getElementById(targetL1SubmenuId);
          const mediaPlayerL1Submenu = document.getElementById('import-media-submenu');
          const mediaPlayerCategoryItem = document.querySelector('.category-item[data-action="import-media"]');

          // const wasSelected = item.classList.contains('selected'); // Not strictly needed for current logic flow

          // Deselect all other category items first
          categoryItems.forEach(catItem => {
            if (catItem !== item) {
              catItem.classList.remove('selected');
            }
          });

          // Toggle selection for the clicked item
          item.classList.toggle('selected');

          if (!item.classList.contains('selected')) {
            // Item was deselected
            if (isEffectsAction || isTransitionsAction) {
              await closeLevel2Submenus();
              // If Media Player L1 is active (which it would be for Effects/Transitions), close it.
              if (mediaPlayerL1Submenu && mediaPlayerL1Submenu.classList.contains('active')) {
                await closeLevel1Submenus(); // This will also close L2 if open.
              }
              // Also deselect Media Player if Effects/Transitions are deselected
              if (mediaPlayerCategoryItem) {
                mediaPlayerCategoryItem.classList.remove('selected');
              }
            } else if (targetL1Submenu && targetL1Submenu.classList.contains('active')) {
              // If a standard L1 item is deselected, close its submenu
              await closeLevel1Submenus();
            }
            return;
          }

          // Item is now selected
          if (isEffectsAction || isTransitionsAction) {
            // Special handling for Effects/Transitions:
            if (mediaPlayerCategoryItem) {
              mediaPlayerCategoryItem.classList.add('selected'); // Ensure Media Player is also selected
            }
            // item.classList.add('selected'); // Already handled by toggle above

            const l1Opened = await openL1Submenu(mediaPlayerL1Submenu);
            if (l1Opened) {
              // MODIFIED: Added setTimeout(0) to defer L2 opening slightly
              setTimeout(() => {
                const internalButtonId = isEffectsAction
                        ? 'effects-quick-nav-button'
                        : 'transitions-quick-nav-button';
                const internalButton = document.getElementById(internalButtonId);

                if (internalButton) {
                  internalButton.click();
                } else {
                  WallpaperApp.MenuTools.openL2Submenu(
                          isEffectsAction ? 'effects-list-submenu' : 'transitions-list-submenu'
                  );
                }
              }, 0); // Delay of 0 milliseconds
            }
          } else {
            // Standard L1 submenu handling
            await closeLevel2Submenus(); // Close any L2 first
            if (targetL1Submenu) {
              await openL1Submenu(targetL1Submenu);
            } else {
              // If no target L1 (e.g., a button without a submenu), close any existing L1s.
              await closeLevel1Submenus();
              item.classList.remove('selected'); // And deselect the item if it has no submenu
            }
          }
        });
      });

      // L2 submenu management
      WallpaperApp.MenuTools.openL2Submenu = async function(submenuIdL2) {
        const submenuL2 = document.getElementById(submenuIdL2);
        if (!submenuL2) return;

        const currentActiveL2Wrapper = document.querySelector('.submenu-wrapper-l2.active');
        const currentActiveL2Submenu = currentActiveL2Wrapper ? currentActiveL2Wrapper.querySelector('.slide-submenu-l2.active') : null;


        if (currentActiveL2Submenu && currentActiveL2Submenu !== submenuL2) {
          // Switching L2 submenus
          currentActiveL2Submenu.classList.remove('active');
          currentActiveL2Submenu.querySelectorAll('.intensity-slider-container.visible').forEach(c => {
            c.classList.remove('visible');
            c.style.maxHeight = '0px';
          });
          currentActiveL2Submenu.querySelectorAll('.submenu-item-l2.expanded').forEach(i => {
            i.classList.remove('expanded');
          });

          afterTransition(currentActiveL2Submenu, () => { // Wait for old panel to slide out
            if (currentActiveL2Wrapper && !currentActiveL2Wrapper.contains(currentActiveL2Submenu)) {
              // If the old submenu is no longer in the active wrapper (e.g. wrapper itself closed), do nothing further here.
            }
            submenuL2.classList.add('active'); // New panel slides in
            mainMenu.classList.add('main-menu-l2-active');
          });
        } else if (!currentActiveL2Submenu || currentActiveL2Submenu !== submenuL2) {
          // Opening a new L2 submenu or re-opening the same L2 submenu
          if (currentActiveL2Submenu && currentActiveL2Submenu !== submenuL2) {
            currentActiveL2Submenu.classList.remove('active');
          }

          submenuL2.classList.add('active');
          submenuWrapperL2.style.display = 'block';

          // MODIFIED: Force a reflow before adding class for transition
          void submenuWrapperL2.offsetHeight;

          requestAnimationFrame(() => {
            submenuWrapperL2.classList.add('active');
            mainMenu.classList.add('main-menu-l2-active');
          });
        }
      };

      // L2 items with expandable sliders
      const l2Items = document.querySelectorAll('.submenu-item-l2');
      l2Items.forEach(item => {
        item.addEventListener('click', () => {
          const parentMenu = item.closest('.slide-submenu-l2');
          if (!parentMenu) return;

          const effectId = item.getAttribute('data-effect-id');
          const transitionId = item.getAttribute('data-transition-id');
          const itemId = effectId || transitionId;

          let sliderContainer = item.nextElementSibling;
          if (!sliderContainer || !sliderContainer.classList.contains('intensity-slider-container')) {
            sliderContainer = document.createElement('div');
            sliderContainer.className = 'intensity-slider-container';
            item.parentNode.insertBefore(sliderContainer, item.nextSibling);
          }

          const isCurrentlyVisible = sliderContainer.classList.contains('visible');

          parentMenu.querySelectorAll('.intensity-slider-container.visible').forEach(container => {
            if (container !== sliderContainer) {
              container.classList.remove('visible');
              container.style.maxHeight = '0px';
              const prevSibling = container.previousElementSibling;
              if (prevSibling && prevSibling.classList.contains('submenu-item-l2')) {
                prevSibling.classList.remove('expanded');
              }
            }
          });

          parentMenu.querySelectorAll('.submenu-item-l2.expanded').forEach(otherItem => {
            if (otherItem !== item) {
              otherItem.classList.remove('expanded');
            }
          });

          if (isCurrentlyVisible) {
            sliderContainer.classList.remove('visible');
            sliderContainer.style.maxHeight = '0px';
            item.classList.remove('expanded');
          } else {
            sliderContainer.innerHTML = `
                <input type="range" class="intensity-slider" min="0" max="100" value="50" data-id="${itemId}">
                <span class="intensity-value">50%</span>
              `;

            const sliderInput = sliderContainer.querySelector('.intensity-slider');
            const valueSpan = sliderContainer.querySelector('.intensity-value');

            if (sliderInput && valueSpan) {
              sliderInput.addEventListener('input', (e) => {
                const value = e.target.value;
                valueSpan.textContent = `${value}%`;
                console.log(`Applying ${itemId} intensity: ${value}%`);
              });
            }

            sliderContainer.classList.add('visible');
            sliderContainer.style.maxHeight = '50px';
            item.classList.add('expanded');
          }
        });
      });

      // Close button handlers
      submenuCloseButtonsL1.forEach(button => {
        button.addEventListener('click', async () => {
          await closeLevel1Submenus();
          categoryItems.forEach(catItem => catItem.classList.remove('selected'));
        });
      });

      submenuCloseButtonsL2.forEach(button => {
        button.addEventListener('click', async () => {
          await closeLevel2Submenus();
          document.querySelector('.category-item[data-action="effects"].selected')?.classList.remove('selected');
          document.querySelector('.category-item[data-action="transitions"].selected')?.classList.remove('selected');
        });
      });

      // Global escape key handler
      document.addEventListener('keydown', async (e) => {
        if (e.key === 'Escape') {
          const activeModal = document.querySelector('#modal-container .modal.show');
          if (activeModal) {
            WallpaperApp.UI.hideModal(activeModal.id);
          } else if (submenuWrapperL2.classList.contains('active')) {
            await closeLevel2Submenus();
            document.querySelector('.category-item[data-action="effects"].selected')?.classList.remove('selected');
            document.querySelector('.category-item[data-action="transitions"].selected')?.classList.remove('selected');
          } else if (submenuWrapperL1.classList.contains('active')) {
            await closeLevel1Submenus();
            categoryItems.forEach(catItem => catItem.classList.remove('selected'));
          } else if (mainMenu.classList.contains('active')) {
            await closeMainMenu();
          }
        }
      });
    }
  });
</script>
<script src="media-importer.js"></script>
</body>
</html>
